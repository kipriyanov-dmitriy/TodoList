# CI/CD Setup для Android приложения

## Обзор

Этот проект настроен с автоматизированным CI/CD pipeline на GitHub Actions для:
- Автоматической сборки APK при каждом push в main
- Создания релизов с подписанными APK
- Отправки APK в Telegram чаты
- Автоматического версионирования

## Workflows

### 1. `build.yml` - Автоматическая сборка
**Триггер:** Push в main branch
**Действия:**
- Сборка release APK
- Отправка APK в два Telegram чата
- Загрузка APK как артефакт

### 2. `release.yml` - Создание релиза
**Триггер:** Manual (workflow_dispatch)
**Действия:**
- Сборка release APK
- Создание GitHub Release
- Загрузка APK в релиз
- Отправка APK в Telegram чаты

### 3. `version-bump.yml` - Автоматическое версионирование
**Триггер:** Push в main (исключая изменения версии)
**Действия:**
- Автоматическое увеличение patch версии
- Обновление versionCode
- Commit изменений

## Требуемые секреты

Убедитесь, что в настройках репозитория (Settings → Secrets and variables → Actions) настроены следующие секреты:

### Подпись APK
- `SIGNING_KEYSTORE` - Base64-encoded keystore файл
- `SIGNING_KEY_ALIAS` - Алиас ключа
- `SIGNING_KEY_PASSWORD` - Пароль ключа
- `SIGNING_STORE_PASSWORD` - Пароль keystore

### Telegram Bot
- `TELEGRAM_TOKEN` - Токен бота
- `TELEGRAM_CHAT1` - ID первого чата
- `TELEGRAM_CHAT2` - ID второго чата

## Настройка keystore

1. Создайте keystore для подписи:
```bash
keytool -genkey -v -keystore my-release-key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias my-key-alias
```

2. Конвертируйте в base64:
```bash
base64 -i my-release-key.jks | tr -d '\n'
```

3. Добавьте результат в секрет `SIGNING_KEYSTORE`

## Использование

### Автоматическая сборка
При каждом push в main branch автоматически:
- Собирается APK
- Отправляется в Telegram
- Загружается как артефакт

### Создание релиза
1. Перейдите в Actions → Create Release
2. Введите версию (например, 1.0.0)
3. Добавьте описание изменений
4. Запустите workflow

### Автоматическое версионирование
При каждом push в main (кроме изменений версии):
- Patch версия увеличивается автоматически
- Version code обновляется до номера run
- Изменения коммитятся автоматически

## Структура файлов

```
.github/
├── workflows/
│   ├── build.yml          # Автоматическая сборка
│   ├── release.yml        # Создание релиза
│   └── version-bump.yml   # Автоматическое версионирование
```

## Troubleshooting

### Ошибки сборки
1. Проверьте правильность секретов
2. Убедитесь, что keystore корректно закодирован в base64
3. Проверьте логи сборки в Actions

### Ошибки отправки в Telegram
1. Проверьте токен бота
2. Убедитесь, что бот добавлен в чаты
3. Проверьте ID чатов

### Проблемы с версионированием
1. Убедитесь, что workflow имеет права на запись в репозиторий
2. Проверьте формат версии в build.gradle.kts
3. Убедитесь, что нет конфликтов с другими workflow

## Локальная разработка

Для локальной разработки используйте локальный keystore:
```kotlin
// В build.gradle.kts уже настроено автоматическое переключение
// между CI и локальной конфигурацией
```

## Безопасность

- Никогда не коммитьте keystore файлы
- Используйте GitHub Secrets для хранения чувствительных данных
- Регулярно обновляйте токены и пароли
- Ограничьте доступ к репозиторию только необходимыми пользователями
